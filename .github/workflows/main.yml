name: ownCloud CI

on: 
  pull_request:
    branches:
      - "master"
      - "2.7"
    
  push:
    branches:
      - "master"
      - "2.7"

defaults:
  run:
    shell: pwsh

jobs:
# ------------------------------------------------------------------------------------------------------------------------------------------
  build:
    name: Build ownCloud
    runs-on: ${{ matrix.os }}
    strategy:
        matrix:
            craft: ["function craft() { ${{ matrix.python }} \"${{ github.workspace }}/CraftMaster/CraftMaster/CraftMaster.py\" --config \"${{ github.workspace }}/.craft.ini\" --target ${{ matrix.target }} --variables \"WORKSPACE=${{ github.workspace }}\" -c $args }"]
            include:
            - target: windows-msvc2017_32-cl
              os: windows-latest
              python: py
            - target: windows-msvc2017_64-cl
              os: windows-latest
              python: py
            - target: macos-64-clang
              os: macos-latest
              python: python3

    steps:
    - name: Check out source code
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: true

    - name: Clone CraftMaster
      run: git clone --depth=1 https://invent.kde.org/kde/craftmaster.git "${{ github.workspace }}/CraftMaster/CraftMaster"

    - name: Craft unshelve
      run:  ${{ github.craft }}; craft --unshelve "${{ github.workspace }}/.craft.shelf

    - name: Install NSIS
      run: ${{ github.craft }}; craft dev-utils/nsis

    - name: Install dependencies
      run: ${{ github.craft }}; craft --install-deps owncloud/owncloud-client

    - name: Build
      run: ${{ github.craft }}; craft --no-cache --src-dir "${{ github.workspace }}" owncloud/owncloud-client

    - name: Run tests
      run: ${{ github.craft }}; craft --no-cache --src-dir "${{ github.workspace }}" --test owncloud/owncloud-client

    - name: Package
      run: ${{ github.craft }}; if ($IsWindows) { $env:CRAFT --no-cache --src-dir "${{ github.workspace }}" --package owncloud/owncloud-client } else {Write-Host "Skip packaging on mac as the build gets stuck when mounting"}

    - name: Update shelf
      run: |
        ${{ github.craft }}
        New-Item -ItemType Directory "${{ github.workspace }}/binaries/" -ErrorAction SilentlyContinue
        craft --shelve "${{ github.workspace }}/.craft.shelf"
        Copy-Item "${{ github.workspace }}/.craft.shelf" "${{ github.workspace }}/binaries/"

    - name: Upload artifacts
      uses: actions/upload-artifact@v2
      with:
        name: ${{ matrix.os }} - ${{ matrix.target }}
        path: ${{ github.workspace }}/binaries/*



